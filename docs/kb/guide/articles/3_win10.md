# How to: Install e3 on Windows 10/11 with WSL

If you are working in a Windows environment and need to run EPICS locally
to test some IOC, most likely you have to install a Linux VM
or have a dual booting machine.

In order to avoid the overhead of a VM or to boot one or the other OS
in your machine, you can work with both OS seamlessly,
installing a Linux Bash Shell on Windows 10/11
through Windows Subsystem for Linux (WSL).

In the bash shell[^winterminal] you can install
all the packages you need via apt command,
like the GNU Linux Compiler Collection
and all the libraries you need to compile EPICS.

This is a guide to install EPICS on a Windows 10 or 11,
with Debian 12/Ubuntu 22.04 WSL1[^WSL1] (only Windows 10)
or WSL2 (Windows 10 or 11).
Although the current Linux OS used for IOC deployment is CentOS7,
we will soon move to Ubuntu 22.04, so this guide could also be helpful
to check the EPICS modules compatibility between the two Linux distros[^redhat].

:::{important}
For any clarification, questions, concerns, please send a mail to <alfio.rizzo@ess.eu>
:::

:::{tip}
It is highly suggested to **change the ownership** of the EPICS installation
directory to your `username/usergroup` (look at `man chown` for instructions)
if it is located in path where root is the owner
(e.g. `/ , /usr/local , /opt`), to avoid to use
the sudo command during the installation.
:::

:::{tip}
You can parallelize the compilation using the **make -j option**,
so the installation can be speeded up !
Set this environment variable before to start the compilation:
`export MAKEFLAGS="-jN"`, where `N` is the number of CPUs you want to use.
However we suggest to use only **2** CPUs since the compilation of the **e3-base**
could sporadically stop if you put more cores, moreover not all the e3 modules
are built to be compiled in parallel mode (e.g. sequencer),
but at least the compilation time will be reduced by a factor of two.
:::

:::{note}

The guide below is applicable also to a pure Debian/Ubuntu Linux OS
if the steps followed are the same as the ones for WSL2.

:::

## Step-by-step guide

1. Install WSL and your preferred Linux Shell (Debian or Ubuntu)  (see
   <https://docs.microsoft.com/en-au/windows/wsl/install-win10> )

2. Once you run the Shell, it will ask you to create a UNIX username/password.
   :::{tip}
   It is suggested to create an account with the same username (password)
   as the one in the ESS domain, since it would be more practical
   when working in the ESS network.
   :::
3. Update the system:

   ```console
   [user@host:~]$ sudo apt update
   [user@host:~]$ sudo apt upgrade
   ```

4. Install the packages needed to compile the different EPICS modules.
   Depending on the specification file you will use, you would need to install
   several packages. The packages needed for almost the epics modules
   installation are listed in this text file
   {download}`epicspkg.txt <https://gitlab.esss.lu.se/alfiorizzo/wslpkg/-/raw/main/epicspkg.txt>`,
   which is stored in the following git repo: [wslpkg](https://gitlab.esss.lu.se/alfiorizzo/wslpkg)

   :::{warning}
   If your installation fails since there were some missing packages,
   please open a MR then they will be added in the epicspkg.txt file.
   :::
   So then please download the file and run the following command:

   ```console
   [user@host:~]$ xargs -a epicspkg.txt sudo apt install
   ```

5. Install the **e3** tool package,
   then **go directly to point 10 if you have WSL2**
   - <https://gitlab.esss.lu.se/e3/e3>

      :::{tip}
      You can install e3 with **pipx** package, using the following command:

      ```console
      [user@host:~]$ pipx install --index-url="https://artifactory.esss.lu.se/artifactory/api/pypi/pypi-virtual/simple" e3
      ```

6. Create an e3 build directory in your `$HOME` or elsewhere, e.g.

   ```console
   [user@host:~]$ mkdir epicsbuild
   ```

7. Clone in the build directory the **e3-base** with
   the same tag you have in your specification file

   ```console
   [user@host:~/epicsbuild]$ git clone https://gitlab.esss.lu.se/e3/wrappers/e3-base/ -b <tag>
   ```

8. Go inside the e3-base directory and open the `configure/CONFIG_BASE`
   file and change the absoulte installation path `E3_EPICS_PATH:=/epics`
   to your preferred installation location.
   Copy the patch file {download}`blocking_udp_transport_wsl.p0.patch <https://gitlab.esss.lu.se/alfiorizzo/wslpkg/-/raw/main/blocking_udp_transport_wsl.p0.patch>`
   to the `patch` directory.
9. Then do

    ```console
    [user@host:~/epicsbuild/e3-base]$ make init
    [user@host:~/epicsbuild/e3-base]$ make patch
    [user@host:~/epicsbuild/e3-base]$ make build
    ```

10. Run the **e3-build** script using your preferred specification file.
   For instance we have selected some of the EPICS modules
   in the specification files
   {download}`2023q1_snippet.yml <https://gitlab.esss.lu.se/alfiorizzo/wslpkg/-/raw/main/2023q1_snippet.yml>`,
   {download}`2024_snippet.xml <https://gitlab.esss.lu.se/alfiorizzo/wslpkg/-/raw/main/2024q1_snippet.yml>`,
   which are needed to run a
   **PLC IOC**, a **SNL IOC** or a **StreamDevice IOC**.
   The use case to run those IOCs is mostly for testing/simulation purpose,
   e.g. the **Siemens PLC Sim Advannced**[^plcsim] tool along with the related **IOC/OPI**.

   :::{warning}
   **Only for WSL1**:

   The build directory (e.g. `epicsbuild`) must be
   the same you have created in point 6.

   The installation path must be the one you have declared in point 8.
   :::

:::{admonition} And, at the end...
If the build ends successfully, then you can run your local IOC!
:::

:::{note}
**Only for WSL1 or WSL2 on Windows10 Build < 19044**:

As optional, if you like to have also a X Window Server to open Linux GUI,
you can install [Xming](https://sourceforge.net/projects/xming/)
or [VcXsrv](https://sourceforge.net/projects/vcxsrv/) X server

So then remember to add this environment variable to your `.bashrc`

   WSL1: `export DISPLAY=localhost:0.0`

   WSL2: `export DISPLAY=$(grep -m 1 nameserver /etc/resolv.conf | awk '{print $2}'):0.0`
:::

:::{note}
**Only for WSL2 on Windows 10 Build 19044+ or Windows 11**:

X11 and Wayland Server are natively supported seamlessly and the `$DISPLAY`
environment variable is set automatically,
see <https://learn.microsoft.com/en-us/windows/wsl/tutorials/gui-apps>.

:::

:::{tip}
From the Linux Shell you can access your Windows disk as well, which is usually
mounted on `/mnt/c`.

And you can run also Windows exe files from the shell, like for instance
`NETSTAT.exe`.
:::

[^winterminal]: If you like to open multiple shells in a console window
you can use the new [windows terminal](https://apps.microsoft.com/detail/9n0dx20hk701?hl=en-us&gl=US).

[^WSL1]: There is only one caveat for WSL1, which is the different way Windows and
Linux bind a multicast UDP socket (needed by PV Access, while there is
no problem with CA access). So even if you are using GCC Linux, since you are
not running on a VM, you should use the Windows way to bind the socket.
This is not handled in the EPICS source code, but it can be fixed with
a patch on the file `blockingUDPTransport.cpp`.
and in this guide it is explained how to apply the patch.
However the binding of multicast UDP socket was fixed in WSL2,
so we strongly suggest to upgrade to WSL2 when possible,
since in addition to containing fixes and improvements,
WSL2 uses a subset of the Hyper-V architecture to enable virtualization,
thus resulting in a pure virtual machine.

[^redhat]: For those who prefer other Linux OS distros, WSL2 also supports
CentOS/Fedora Linux distros including also RedHat,
see for instance installation instruction for RedHat
[here](https://developers.redhat.com/articles/2023/12/21/getting-started-rhel-windows-subsystem-linux).

[^plcsim]: The Siemens PLC Sim Advanced tool run only on Windows,
so it is most natural to use WSL to run a local IOC.
