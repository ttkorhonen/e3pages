# How to: Install e3 on Windows 10/11 with WSL

:::{note}
This is a guide to install EPICS on a Windows 10 or 11,
with Debian 12/Ubuntu 22.04 WSL1 (only Windows 10) or WSL2 (Windows 10 or 11).
Although the current Linus OS used for IOC deployment is CentOS7,
we will soon move to Ubuntu 22.04, so this guide could be also helpful
to check the EPICS modules compatibility between the two Linux distros.

For those who prefer other Linux OS distros, WSL2 does support also
CentOS/Fedora Linux distros including also RedHat,
see for instance installation instruction for RedHat
[here](https://developers.redhat.com/articles/2023/12/21/getting-started-rhel-windows-subsystem-linux).

:::

If you are working in a Windows environment and need to run locally EPICS
to test some IOC, most likely you have to install a Linux VM
or have a dual booting machine.

In order to avoid the overhead of a VM or to boot one or the other OS
in your machine, you can work with both OS seamlessly,
installing a Linux Bash Shell on Windows 10/11
through Windows Subsystem for Linux (WSL).

In the bash shell you can install all the packages you need via apt command,
like the GNU Linux Compiler Collection
and all the libraries you need to compile EPICS.

If you like to open multiple shell in a console window
you can use the new [windows terminal](https://apps.microsoft.com/detail/9n0dx20hk701?hl=en-us&gl=US).

:::{warning}
**Only for WSL1**:

There is only one caveat for WSL1, which is the different way Windows and
Linux bind a multicast UDP socket (needed by PV Access, while there is
no problem with CA access). So even if you are using GCC Linux,
since you are not running on a VM, you should use Windows way to bind socket.
This is not handled in the EPICS source code, but can it be fixed with
a patch on the file `blockingUDPTransport.cpp`.
Further on this guide, it is explained how to apply the patch.

The binding of multicast UDP socket was fixed in WSL2,
so we strongly suggest to upgrade to WSL2 when possible,
since in addition to containing fixes and improvements,
WSL2 uses a subset of the Hyper-V architecture to enable virtualization,
thus resulting in a pure virtual machine.

:::

:::{note}
**Only for WSL1 or WSL2 on Windows10 Build < 19044**:

As optional, if you like to have also a X Window Server to open Linux GUI,
you can install [Xming](https://sourceforge.net/projects/xming/)
or [VcXsrv](https://sourceforge.net/projects/vcxsrv/) X server

So then remember to add this env variable to your `.bashrc`

   WSL1: `export DISPLAY=localhost:0.0`

   WSL2: `export DISPLAY=$(grep -m 1 nameserver /etc/resolv.conf | awk '{print $2}'):0.0`
:::

:::{note}
**Only for WSL2 on Windows 10 Build 19044+ or Windows 11**:

X11 and Wayland Server are natively supported seamlessy and the `$DISPLAY`
env is set automatically, see <https://learn.microsoft.com/en-us/windows/wsl/tutorials/gui-apps>.

:::

:::{tip}

Suggested editor: [vscode](https://code.visualstudio.com/docs/remote/wsl)

:::

:::{note}

The guide below is applicable also to a pure Debian/Unutu Linux OS
if the steps followed are the same as the ones for WSL2.

:::

## Step-by-step guide

1. Install WSL and your preferred Linux Shell (Debian or Ubuntu)  (see
   <https://docs.microsoft.com/en-au/windows/wsl/install-win10> )

2. Once you run the Shell, it will ask you to create a UNIX username/password.
   :::{tip}
   It is suggesteed to create an account with the same username (password)
   as  the one in ESS domain, since would be more practical
   when working in the ESS network.
   :::
3. Update the system:

   ```console
   [user@host:~]$ sudo apt update
   [user@host:~]$ sudo apt upgrade
   ```

4. Install the packages needed to compile the different EPICS modules.
   Depending on the specification file you will use, you would need to install
   several packages. You can compile all the modules listed for instance
   in the **2023q1.yml** and the latest **2024q1.yml** specification files,
   with the following caveats:
   - The EtherCAT driver was not tested, so you have to comment out
   **ecmc** module in the specification files.
   - Only the **0.9.5-betaopen62541**[^opcua] version opcua module can be compiled
   at the moment, so you have to comment out all the other vesions
   in the specification file. The compilation will likely fails at
   the first attempt, so you have to apply some fixes and restart
   the installation, see the instructions later in this guide.
   - The module **cfhvacms** is deprecated since the **0.9.5-betaopen62541**
   version opcua module and it should be commented out if present in the
   specification file.
   - Only the version from **2.0.0** of the module **srf_cplconditioning** can
   be compiled, so please comment out other versions (if any)
   in the specification file.

   The packages needed for the full epics modules installation are in this
   text file {download}`epicspkg.txt`, so please download it
   and run the following command:

   ```console
   [user@host:~]$ xargs -a epicspkg.txt sudo apt install
   ```

   :::{warning}
   If your installation fails since there were some missing packages,
   please report then I will add them in the epicspkg.txt file
   :::

   Hints for some EPICS module compilation:
   - **e3-iseghal_service**: create a symbolic link for qmake
   inside the `$HOME/.local/bin` directory using the command

      ```console
      [user@host:~/.local/bin]$ ln -s /usr/lib/x86_64-linux-gnu/qt5/bin/qmake qmake-qt5
      ```

      and ensure that `$HOME/.local/bin` is in your `PATH`
   - **e3-openipmi module**: do

      ```console
      [user@host:~]$ export PYTHONWARNINGS="ignore"
      ```

5. Install the **e3** tool and **e3 specifications** packages,
   then **go directly to point 10 if you have WSL2**
   - <https://gitlab.esss.lu.se/e3/e3>

      :::{tip}
      You can install e3 with **pipx** package, using the following command:

      ```console
      [user@host:~]$ pipx install --index-url="https://artifactory.esss.lu.se/artifactory/api/pypi/pypi-virtual/simple" e3
      ```

      :::
   - <https://gitlab.esss.lu.se/e3/specifications>

6. Create an e3 build directory in your `$HOME` or elsewhere, e.g.

   ```console
   [user@host:~]$ mkdir epicsbuild
   ```

7. Clone in the build directory the **e3-base**
   which contains the **patch** for **WSL1**
   - <https://gitlab.esss.lu.se/alfiorizzo/e3-base/>

8. Go inside the e3-base directory and open the `configure/CONFIG_BASE`
   file and change the absoulte installation path `E3_EPICS_PATH:=/epics`
   to your preferred installation location (you can of course keep /epics).
   However mind to **change the ownership** to your username/usergroup
   if the installation folder belong to root to avoid to use the sudo command
   during installation. For instructions do `man chown`

9. Then do

    ```console
    [user@host:~/epicsbuild/e3-base]$ make init
    [user@host:~/epicsbuild/e3-base]$ make patch
    [user@host:~/epicsbuild/e3-base]$ make build
    ```

10. Run the e3-build tool using your preferred specification
   :::{tip}
   You can parallelize the compilation using the **make -j option**,
   so the installation can be speeded up !
   Set this environment variable: `export MAKE="make -jN"`,
   where `N` is the numer of CPUs you want to use,
   e.g. `export MAKE="make -j8"` ; if you want to use all the available
   ones you can do `export MAKE="make -j$(nproc)"`

   If you want to have more verbosity to troubleshoot during installation
   you can add the -v option to the below command!
   :::

   ```console
   [user@host:~]$ e3-build -b <builddir> -t <epicsinstallation> <pathtospectificationfile>
   ```

   where

- `<builddir>` is a build directory you can create (e.g. `mkdir epicsbuild`)
   or is the same build directory you may have already
   created in point 6 if you run on WSL1

- `<epicsinstallation>` is the installation path, and it can be
   the one you may have already declared in point 8 if you run on WSL1.
   It is highly suggested to **change the onwership** of the directory
   to your `username/usergroup` (look at `man chown` for instructions)
   if it is located in path where root is the owner
   (e.g. `/ , /usr/local , /opt`) to avoid to use
   the sudo command for the installation

- `<pathtospectificationfile>` is the path to your specificaiton file,
   e.g. `<WHEREIHAVECLONED>/specifications/spectifications/2023q1.yml`

   If you want to install **OPCUA** module, as I said above the compilation
   will fail at first time, so you have to open `opcua.Makefile`
   in the directory `<builddir>/e3-opcua` and add at the very beginning
   this line `SHELL = /bin/bash`, replace at the bottom `cmake3` with `cmake`,
   then restart from the e3-build command

:::{admonition} And, at the end...
If the build ends successfully, then you can run your local IOC!
:::

:::{tip}
From the Linux Shell you can access your Windows disk as well, which is usually
mounted on `/mnt/c`.

And you can run also Windows exe files from the shell, like for instance
`NETSTAT.exe`.
:::

:::{note}
For any clarification, questions, concerns, please send a mail to <alfio.rizzo@ess.eu>
:::

[^opcua]: At the time of the release of this guide the OPCUA 0.9.5 module version
was still in beta. So when the stable version would be released,
the compilation would be ok for future release, i.e. 0.9.5+
