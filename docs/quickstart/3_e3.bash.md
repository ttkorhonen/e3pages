# e3.bash

Included with the main e3 repository are a pair of scripts, `e3_building_config.bash` and `e3.bash`. They can be used
to automate setting up a local  e3 environment. In particular, they can do all of the following.

* Set which version of EPICS base/require you would like to install
* Decide on the install location
* Build and install EPICS base with the patches needed to use e3
* Build and install require
* Build and install groups of modules

An example of the above is the following.

```bash
$ bash e3_building_config.bash -b 7.0.4 -r 3.3.0 -t /opt/epics setup
$ bash e3.bash base
$ bash e3.bash req
$ bash e3.bash -c mod
```
This set of commands will build and install EPICS base 7.0.4 together with require 3.3.0 at the location
`/opt/epics/`, and then install all of the common modules.

:::{note}
This documentation is for the current version `0.1.0` of `e3.bash`. We intend to revisit these tools in
the near future and so it is very likely that there will be changes to the material below.
:::

## Configuring EPICS base/require versions

Configuration for your local install is done with `e3_building_config.bash`. The usage for this is as follows.

```bash
$ bash e3_building_config.bash -h

Usage    : e3_building_config.bash options setup 

              possbile options

              [-t <target_path>]     [-b <base_version>]      [-r <require_version>] [-c <base_tag>] 
              [-n <ifc14xx_cc_path>] [-m <ifc14xx_cc_version] [-l <poky_cc_path]     [-k <poky_cc_version>] 

               -t : default /epics
               -b : default 7.0.4
               -r : default 3.3.0
               -c : default 7.0.4
               -n : default /opt/ifc14xx
               -m : default 2.6-4.14
               -l : default /opt/cct
               -k : default 2.6-4.14

 bash e3_building_config.bash -t ${HOME} -r 3.3.0 setup
```

The main options to use are the ones listed in the example: `-b` to selecte the version of EPICS base, `-r` to
select the version of `require`, and `-t` to select the desired install location.

The result of this script is the generation of a number of different `.local` files, such as `CONFIG_BASE.local`,
`REQUIRE_CONFIG_MODULE.local`, `RELEASE.local`, and `RELEASE_DEV.local`. These are used to override the configuration
options in the different repositories.

## Building EPICS base

The basic philosophy of e3 is to use wrappers which contain metadata (and possibly some patches) to allow for
consistent custom building of community EPICS modules with minimal changes required. EPICS base is built in 
the same way, using the wrapper [e3-base](https://gitlab.esss.lu.se/e3/e3-base). The main purpose of this wrapper
is to configure EPICS base and to apply certain site-specific patches that are necessary for the e3 EPICS environment.

In order to use `e3.bash` to build EPICS base, you should run
```bash
$ bash e3.bash base
```
This will clone EPICS base, apply the necessary patches[^patches], and build it with the configuration supplied above.

Note that EPICS base takes a while to build! Go get yourself a coffee.

## Building require

Require is an integral part of e3. As stated elsewhere, in a certain sense require *is* e3. So of course we need to
install that next, which is done via
```bash
$ bash e3.bash req
```
This is must simpler and quicker than EPICS base. If you have been following the steps above, then this will be
installed together with EPICS base in the path `${EPICS_BASE}/require/${E3_REQUIRE_VERSION}`.

## Building modules

Finally, we will want to build a number of EPICS modules. The ESS e3 wrappers are organized into different
groups. The general syntax for installing a group with `e3.bash` is
```bash
$ bash e3.bash -<group>[o] mod
```
The groups have dependencies between them, which will be described below. If you run e.g.
```bash
$ bash e3.bash -a mod
```
then it will install the *area* group as well as its dependencies. If you wish to install only that group without
its dependencies (for example, you may have already installed them and do not wish to re-install them)[^dependencies], then you
would instead run
```bash
$ bash e3.bash -ao mod
```
The `o` stands for "only".

The current collection are as follows.
* [common](https://gitlab.esss.lu.se/e3/common): Modules that are not specific to one section or another,
  and are generally useful across a wide variety of IOCs. For example, *[asyn](https://gitlab.esss.lu.se/e3/common/e3-asyn)*
  is used by many IOCs, at least implicitly. Many of the other groups depend on modules within this group,
  so it is likely that you will need to install this group first.
  
  Installation:
  ```bash
  $ bash e3.bash -c mod
  ```
* [area](https://gitlab.esss.lu.se/e3/area): Area detector modules. These are generally used for communicating
  with specific camera hardwards and many have specific vendor libraries that need to be installed with them.
  This group requires *asyn* to be installed, and so you should install the *common* group before installing this
  one..

  Installation:
  ```bash
  $ bash e3.bash -a mod
  ```
  Dependencies: *common*
* [ts](https://gitlab.esss.lu.se/e3/ts): Timing system modules. These are used by the timing system at ESS.
  
  Installation:
  ```bash
  $ bash e3.bash -t mod
  ```
* [psi](https://gitlab.esss.lu.se/e3/psi): PSI Modules. These are a set of modules developed at *[PSI](https://www.psi.ch/en)*
  which provide some nice additional functionality. For example, there is a [module](https://gitlab.esss.lu.se/e3/psi/e3-iocshUtils)
  that allows you to add new breakpoint tables as an IOC starts up.

  Installation:
  ```bash
  $ bash e3.bash -p mod
  ```
  Dependencies: *common*
* [ifc](https://gitlab.esss.lu.se/e3/ifc): IFC Modules
  
  Installation:
  ```bash
  $ bash e3.bash -i mod
  ```
  Dependencies: *common*
* [ecat](https://gitlab.esss.lu.se/e3/ecat): Ethercat modules. Requires *[etherlabmaster](https://gitlab.esss.lu.se/ics-infrastructure/etherlabmaster)*.
  
  Installation:
  ```bash
  $ bash e3.bash -e mod
  ```
  Dependencies: *common*
* [ps](https://gitlab.esss.lu.se/e3/ps): Power supply modules. 
  
  Installation:
  ```bash
  $ bash e3.bash -s mod
  ```
  Dependencies: *common*
* [vac](https://gitlab.esss.lu.se/e3/vac): Vacuum modules (from PLC Factory)
  
  Installation:
  ```bash
  $ bash e3.bash -v mod
  ```
  Dependencies: *common*
* [rf](https://gitlab.esss.lu.se/e3/rf): RF Modules. Formely Low-Level Radio Frequency, renamed due to the fact that these will be used
  for more than just the LLRF system.
  
  Installation:
  ```bash
  $ bash e3.bash -l mod
  ```
  Dependencies: *common*
* [bi](https://gitlab.esss.lu.se/e3/bi): Beam Instrumentation modules
  
  Installation:
  ```bash
  $ bash e3.bash -b mod
  ```
  Dependencies: *common*, *area*


[^patches]: To see what patches are included, see [here](https://gitlab.esss.lu.se/e3/e3-base/-/tree/master/patch/Site).
There is some documentation for these patches in the README.md and History.md files, but they are incomplete.

[^dependencies]: If you do not install the dependencies first, it is very likely that your build will fail as it will
be missing header files that are needed for the build.